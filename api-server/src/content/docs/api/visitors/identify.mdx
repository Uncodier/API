# Endpoint de Identificación

El endpoint `/api/visitors/identify` permite vincular un visitante anónimo con información de identificación conocida, como un ID de usuario, correo electrónico o cualquier otro identificador personalizado. Esto permite unificar el seguimiento entre sesiones, dispositivos y estados de autenticación.

## Especificación de la API

- **URL**: `/api/visitors/identify`
- **Método**: `POST`
- **Formato de datos**: JSON
- **Autenticación**: API Key en encabezado `X-SA-API-KEY`

## Parámetros del Request

| Parámetro | Tipo | Requerido | Descripción |
|-----------|------|-----------|-------------|
| `site_id` | string | Sí | Identificador único del sitio |
| `visitor_id` | string | Sí | ID del visitante anónimo generado por el script de tracking |
| `user_id` | string | Sí* | Identificador único del usuario en tu sistema (*al menos uno de `user_id` o `traits` debe proporcionarse) |
| `traits` | object | Sí* | Atributos del usuario para identificación (*al menos uno de `user_id` o `traits` debe proporcionarse) |
| `timestamp` | number | No | Marca de tiempo en milisegundos |

### Estructura de traits

El objeto `traits` puede incluir cualquier propiedad para identificar y enriquecer el perfil del usuario:

```json
{
  "email": "email@ejemplo.com",
  "name": "Nombre Completo",
  "first_name": "Nombre",
  "last_name": "Apellido",
  "phone": "+34123456789",
  "gender": "female",
  "age": 32,
  "birthday": "1990-01-15",
  "address": {
    "street": "Calle Principal 123",
    "city": "Madrid",
    "state": "Madrid",
    "postalCode": "28001",
    "country": "España"
  },
  "company": {
    "name": "Empresa SA",
    "industry": "Tecnología",
    "employee_count": 120
  },
  "subscription": {
    "plan": "premium",
    "status": "active",
    "started_at": "2023-01-01"
  }
}
```

## Ejemplo de payload

### Identificación básica

```json
{
  "site_id": "site_123abc",
  "visitor_id": "vis_abcd1234",
  "user_id": "usr_5678",
  "timestamp": 1646123456789
}
```

### Identificación con atributos detallados

```json
{
  "site_id": "site_123abc",
  "visitor_id": "vis_abcd1234",
  "user_id": "usr_5678",
  "traits": {
    "email": "usuario@ejemplo.com",
    "name": "Ana García",
    "first_name": "Ana",
    "last_name": "García",
    "phone": "+34612345678",
    "subscription": {
      "plan": "premium",
      "status": "active",
      "started_at": "2023-06-15"
    },
    "company": {
      "name": "Empresa Innovadora SL",
      "role": "Marketing Manager"
    }
  },
  "timestamp": 1646123456789
}
```

## Respuesta

```json
{
  "success": true,
  "visitor_id": "vis_abcd1234",
  "user_id": "usr_5678",
  "profile_id": "prof_987654",
  "merged": true,
  "merged_ids": ["vis_previous1", "vis_previous2"]
}
```

## Códigos de estado HTTP

- `200 OK`: Identificación exitosa
- `400 Bad Request`: Parámetros inválidos o faltantes
- `401 Unauthorized`: API key inválida o faltante
- `403 Forbidden`: El sitio no tiene permisos para usar esta funcionalidad
- `429 Too Many Requests`: Se ha excedido el límite de peticiones
- `500 Internal Server Error`: Error en el servidor

## Gestión de errores

En caso de error, la respuesta incluirá detalles sobre el problema:

```json
{
  "success": false,
  "error": {
    "code": "invalid_parameters",
    "message": "Se debe proporcionar al menos user_id o traits",
    "details": {
      "missing_fields": ["user_id or traits"]
    }
  }
}
```

## Fusión de perfiles

Cuando un visitante anónimo se identifica con un `user_id` que ya existe, los perfiles se fusionan automáticamente:

1. Se crea un perfil unificado (si no existe)
2. Se vinculan todos los `visitor_id` al mismo perfil
3. El historial de eventos y sesiones de todos los perfiles vinculados se unifica
4. Las propiedades de los perfiles se combinan, dando prioridad a los datos más recientes

## Propiedades reservadas

Algunas propiedades en `traits` tienen un significado especial y se tratan de manera específica:

| Propiedad | Tipo | Descripción |
|-----------|------|-------------|
| `email` | string | Correo electrónico principal |
| `name` | string | Nombre completo |
| `first_name` | string | Nombre |
| `last_name` | string | Apellido |
| `phone` | string | Número de teléfono |
| `gender` | string | Género ("male", "female", "other") |
| `age` | number | Edad en años |
| `birthday` | string | Fecha de nacimiento (formato ISO: "YYYY-MM-DD") |
| `avatar` | string | URL de la imagen de perfil |
| `title` | string | Título o puesto profesional |
| `description` | string | Descripción del usuario |
| `timezone` | string | Zona horaria (e.j. "Europe/Madrid") |
| `locale` | string | Configuración regional (e.j. "es-ES") |

## Actualización de propiedades

Cada vez que se llama al endpoint `identify`, las propiedades del usuario se actualizan:

- Las propiedades nuevas se añaden
- Las propiedades existentes se sobrescriben con los nuevos valores
- Las propiedades que no se incluyen en el request no se modifican

## ID Unification y Cross-Device Tracking

La identificación permite vincular múltiples dispositivos y sesiones al mismo usuario:

1. **Navegación en diferentes dispositivos**: Cuando un usuario inicia sesión desde distintos dispositivos, todos sus `visitor_id` se vinculan al mismo `user_id`

2. **Tracking anónimo e identificado**: El historial de navegación anónima se conserva y vincula al perfil cuando el usuario se identifica

3. **Reconexión de perfiles**: Si un usuario elimina cookies y regresa, el perfil se reconecta al identificarse nuevamente

## Límites y cuotas

- **Tamaño máximo de payload**: 100KB
- **Propiedades máximas en traits**: 100
- **Peticiones por minuto**: 100 por IP
- **Profundidad máxima de objetos anidados**: 5 niveles

## Buenas prácticas

1. **Identificar lo antes posible**: Llama al endpoint `identify` tan pronto como tengas información del usuario (login, registro, etc.)

2. **Mantener consistencia**: Usa los mismos identificadores y estructura de `traits` en todas tus aplicaciones

3. **Identificación progresiva**: Actualiza gradualmente el perfil del usuario a medida que recopiles más información

4. **Privacidad de datos**: Solo recopila y envía los datos necesarios respetando las políticas de privacidad

5. **Consistencia en campos clave**: Usa formatos estándar para email, teléfono, fechas y otros datos estructurados

## Ejemplo de Implementación en Frontend

```javascript
// Ejemplo de uso con el script de tracking
siteAnalyzer.identify('usr_12345', {
  email: 'usuario@ejemplo.com',
  name: 'Juan Pérez',
  company: {
    name: 'Mi Empresa SL',
    role: 'Developer'
  }
});

// También puedes identificar sin user_id, solo con traits
siteAnalyzer.identify({
  email: 'usuario@ejemplo.com',
  newsletter_subscription: true
});
``` 