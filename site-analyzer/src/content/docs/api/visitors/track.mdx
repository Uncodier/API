# Endpoint de Track

El endpoint `/api/visitors/track` es el punto central para registrar eventos de visitantes en tu sitio web. Este endpoint es utilizado por el script de tracking para enviar datos sobre las acciones de los usuarios, pageviews, clics, y eventos personalizados.

## Especificación de la API

- **URL**: `/api/visitors/track`
- **Método**: `POST`
- **Formato de datos**: JSON
- **Autenticación**: API Key en encabezado `X-SA-API-KEY`

## Parámetros del Request

| Parámetro | Tipo | Requerido | Descripción |
|-----------|------|-----------|-------------|
| `site_id` | string | Sí | Identificador único del sitio |
| `event_type` | string | Sí | Tipo de evento (`pageview`, `click`, `custom`) |
| `event_name` | string | No | Nombre del evento personalizado (requerido si `event_type` es `custom`) |
| `url` | string | Sí | URL donde ocurrió el evento |
| `referrer` | string | No | URL de referencia |
| `visitor_id` | string | No | ID único del visitante (generado por el script si no se proporciona) |
| `session_id` | string | No | ID de la sesión actual |
| `timestamp` | number | No | Marca de tiempo en milisegundos (se usa la del servidor si no se proporciona) |
| `properties` | object | No | Propiedades adicionales del evento |
| `user_agent` | string | No | User-Agent del navegador |
| `ip` | string | No | Dirección IP (se captura automáticamente por el servidor) |

## Ejemplo de payload para pageview

```json
{
  "site_id": "site_123abc",
  "event_type": "pageview",
  "url": "https://ejemplo.com/productos",
  "referrer": "https://google.com",
  "visitor_id": "vis_abcd1234",
  "session_id": "sess_xyz789",
  "timestamp": 1646123456789,
  "properties": {
    "page_title": "Catálogo de Productos",
    "screen_size": "1920x1080",
    "locale": "es-ES"
  }
}
```

## Ejemplo de payload para evento personalizado

```json
{
  "site_id": "site_123abc",
  "event_type": "custom",
  "event_name": "add_to_cart",
  "url": "https://ejemplo.com/productos/zapato-casual",
  "visitor_id": "vis_abcd1234",
  "session_id": "sess_xyz789",
  "timestamp": 1646123456789,
  "properties": {
    "product_id": "prod_123",
    "product_name": "Zapato Casual Negro",
    "price": 49.99,
    "currency": "EUR",
    "quantity": 1
  }
}
```

## Respuesta

El endpoint responde con un objeto JSON que incluye:

```json
{
  "success": true,
  "event_id": "evt_12345abcde",
  "timestamp": 1646123456790
}
```

## Códigos de estado HTTP

- `200 OK`: Evento registrado correctamente
- `400 Bad Request`: Parámetros inválidos o faltantes
- `401 Unauthorized`: API key inválida o faltante
- `403 Forbidden`: El sitio no tiene permisos para usar el tracking
- `429 Too Many Requests`: Se ha excedido el límite de peticiones
- `500 Internal Server Error`: Error en el servidor

## Gestión de errores

En caso de error, la respuesta incluirá detalles sobre el problema:

```json
{
  "success": false,
  "error": {
    "code": "invalid_parameters",
    "message": "El parámetro site_id es obligatorio",
    "details": {
      "missing_fields": ["site_id"]
    }
  }
}
```

## Procesamiento asíncrono

Todos los eventos son procesados de forma asíncrona en segundo plano. El endpoint responde inmediatamente después de validar y encolar el evento, incluso antes de que se complete todo el procesamiento. Esto garantiza una baja latencia para el script de tracking en el cliente.

## Buenas prácticas

1. **Agrupar eventos**: Si es posible, agrupa múltiples eventos en una sola petición para reducir el número de llamadas a la API.

2. **Retry con backoff exponencial**: Implementa un mecanismo de reintento con espera exponencial en el script de tracking para casos de fallo en la red.

3. **Filtrar datos sensibles**: No envíes información personal sensible como contraseñas, números de tarjetas de crédito o datos médicos.

4. **Respetar la privacidad**: Solo envía eventos si el usuario ha aceptado las cookies de análisis.

## Límites y cuotas

- **Máximo de eventos por petición**: 50
- **Tamaño máximo de payload**: 100KB
- **Peticiones por minuto**: 100 por IP
- **Propiedades personalizadas**: 50 por evento 