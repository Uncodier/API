# Endpoint de Segmentación

El endpoint `/api/visitors/segment` permite gestionar la segmentación de visitantes en función de su comportamiento, características demográficas o acciones realizadas en el sitio.

## Especificación de la API

- **URL**: `/api/visitors/segment`
- **Métodos**: `POST`, `GET`, `PUT`, `DELETE`
- **Formato de datos**: JSON
- **Autenticación**: API Key en encabezado `X-SA-API-KEY`

## Crear un nuevo segmento (POST)

### Parámetros del Request

| Parámetro | Tipo | Requerido | Descripción |
|-----------|------|-----------|-------------|
| `site_id` | string | Sí | Identificador único del sitio |
| `name` | string | Sí | Nombre del segmento |
| `description` | string | No | Descripción del segmento |
| `rules` | array | Sí | Array de reglas para la segmentación |
| `is_dynamic` | boolean | No | Si es `true`, los visitantes entran y salen del segmento automáticamente según cumplan las reglas (por defecto: `true`) |
| `color` | string | No | Código de color hexadecimal para identificar visualmente el segmento |

### Estructura de las reglas

Cada regla es un objeto con la siguiente estructura:

```json
{
  "field": "string",     // Campo a evaluar (ej: "page_view.url", "event.name", "visitor.location.country")
  "operator": "string",  // Operador de comparación (ej: "equals", "contains", "gt", "lt")
  "value": "any",        // Valor contra el que comparar
  "type": "string"       // Tipo de regla: "event", "user", "session", "page"
}
```

### Ejemplo de payload

```json
{
  "site_id": "site_123abc",
  "name": "Compradores de calzado",
  "description": "Visitantes que han comprado zapatos en los últimos 30 días",
  "rules": [
    {
      "field": "event.name",
      "operator": "equals",
      "value": "purchase",
      "type": "event"
    },
    {
      "field": "event.properties.category",
      "operator": "contains",
      "value": "zapatos",
      "type": "event"
    },
    {
      "field": "event.timestamp",
      "operator": "gt",
      "value": "now-30d",
      "type": "event"
    }
  ],
  "is_dynamic": true,
  "color": "#FF5733"
}
```

### Respuesta

```json
{
  "success": true,
  "segment_id": "seg_123456",
  "created_at": 1646123456789,
  "estimated_size": 245
}
```

## Obtener información de un segmento (GET)

### Parámetros de URL

| Parámetro | Tipo | Requerido | Descripción |
|-----------|------|-----------|-------------|
| `segment_id` | string | Sí* | ID del segmento a consultar (*requerido si no se especifica `site_id`) |
| `site_id` | string | Sí* | Identificador único del sitio (*requerido si no se especifica `segment_id`) |

### Ejemplos de URL

Para obtener un segmento específico:
```
/api/visitors/segment?segment_id=seg_123456
```

Para listar todos los segmentos de un sitio:
```
/api/visitors/segment?site_id=site_123abc
```

### Respuesta para un segmento específico

```json
{
  "segment_id": "seg_123456",
  "site_id": "site_123abc",
  "name": "Compradores de calzado",
  "description": "Visitantes que han comprado zapatos en los últimos 30 días",
  "rules": [
    {
      "field": "event.name",
      "operator": "equals",
      "value": "purchase",
      "type": "event"
    },
    {
      "field": "event.properties.category",
      "operator": "contains",
      "value": "zapatos",
      "type": "event"
    },
    {
      "field": "event.timestamp",
      "operator": "gt",
      "value": "now-30d",
      "type": "event"
    }
  ],
  "is_dynamic": true,
  "color": "#FF5733",
  "created_at": 1646123456789,
  "updated_at": 1646123456789,
  "visitor_count": 267,
  "conversion_rate": 2.3
}
```

### Respuesta para lista de segmentos

```json
{
  "segments": [
    {
      "segment_id": "seg_123456",
      "name": "Compradores de calzado",
      "description": "Visitantes que han comprado zapatos en los últimos 30 días",
      "visitor_count": 267,
      "conversion_rate": 2.3
    },
    {
      "segment_id": "seg_123457",
      "name": "Visitantes móviles",
      "description": "Usuarios que acceden desde dispositivos móviles",
      "visitor_count": 1255,
      "conversion_rate": 1.8
    }
  ],
  "total": 2,
  "site_id": "site_123abc"
}
```

## Actualizar un segmento (PUT)

### Parámetros del Request

| Parámetro | Tipo | Requerido | Descripción |
|-----------|------|-----------|-------------|
| `segment_id` | string | Sí | ID del segmento a actualizar |
| `site_id` | string | Sí | Identificador único del sitio |
| `name` | string | No | Nuevo nombre del segmento |
| `description` | string | No | Nueva descripción |
| `rules` | array | No | Nuevas reglas de segmentación |
| `is_dynamic` | boolean | No | Si es dinámico o estático |
| `color` | string | No | Nuevo código de color |

### Ejemplo de payload

```json
{
  "segment_id": "seg_123456",
  "site_id": "site_123abc",
  "name": "Compradores frecuentes de calzado",
  "rules": [
    {
      "field": "event.name",
      "operator": "equals",
      "value": "purchase",
      "type": "event"
    },
    {
      "field": "event.properties.category",
      "operator": "contains",
      "value": "zapatos",
      "type": "event"
    },
    {
      "field": "event.count",
      "operator": "gt",
      "value": 2,
      "type": "event"
    }
  ]
}
```

### Respuesta

```json
{
  "success": true,
  "segment_id": "seg_123456",
  "updated_at": 1646124000000,
  "recalculation_status": "in_progress"
}
```

## Eliminar un segmento (DELETE)

### Parámetros del Request

| Parámetro | Tipo | Requerido | Descripción |
|-----------|------|-----------|-------------|
| `segment_id` | string | Sí | ID del segmento a eliminar |
| `site_id` | string | Sí | Identificador único del sitio |

### Ejemplo de URL

```
/api/visitors/segment?segment_id=seg_123456&site_id=site_123abc
```

### Respuesta

```json
{
  "success": true,
  "deleted_at": 1646124000000
}
```

## Operadores disponibles

| Operador | Descripción | Tipos de campo compatibles |
|----------|-------------|----------------------------|
| `equals` | El valor es exactamente igual | string, number, boolean |
| `not_equals` | El valor no es igual | string, number, boolean |
| `contains` | El valor contiene la subcadena | string, array |
| `not_contains` | El valor no contiene la subcadena | string, array |
| `starts_with` | El valor comienza con la subcadena | string |
| `ends_with` | El valor termina con la subcadena | string |
| `gt` | Mayor que | number, date |
| `gte` | Mayor o igual que | number, date |
| `lt` | Menor que | number, date |
| `lte` | Menor o igual que | number, date |
| `between` | Entre dos valores | number, date |
| `in` | El valor está en el array | string, number |
| `not_in` | El valor no está en el array | string, number |
| `exists` | El campo existe | any |
| `not_exists` | El campo no existe | any |
| `regex` | Coincide con la expresión regular | string |

## Valores temporales especiales

Para los campos de tipo fecha/hora, se pueden usar valores relativos:

- `now` - Momento actual
- `now-Xm` - X minutos atrás (ej: `now-30m`)
- `now-Xh` - X horas atrás (ej: `now-12h`)
- `now-Xd` - X días atrás (ej: `now-7d`)
- `now-Xw` - X semanas atrás (ej: `now-2w`)
- `now-XM` - X meses atrás (ej: `now-3M`)
- `today` - Inicio del día actual
- `yesterday` - Inicio del día anterior
- `this_week` - Inicio de la semana actual
- `last_week` - Inicio de la semana anterior
- `this_month` - Inicio del mes actual
- `last_month` - Inicio del mes anterior

## Límites

- **Máximo de segmentos por sitio**: 50
- **Máximo de reglas por segmento**: 20
- **Máximo de operaciones de cálculo de segmentos concurrentes**: 5

## Buenas prácticas

1. **Crear segmentos significativos**: Diseña segmentos que tengan valor para tu análisis de negocio.

2. **Limitar complejidad**: Las reglas muy complejas pueden afectar al rendimiento del cálculo.

3. **Usar segmentos dinámicos**: Para la mayoría de los casos, los segmentos dinámicos son más útiles ya que se actualizan automáticamente.

4. **Documentar bien**: Usa descripciones claras para que otros miembros del equipo entiendan el propósito del segmento. 