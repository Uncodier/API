# Email Analysis

Creates a command object to fetch and analyze email messages from the site's email provider, determine if they require commercial responses, and generate insights using AI agents.

import { UnifiedApiTester } from '@/components/ApiTester';

## Endpoint

```http
POST /api/agents/email
```

## Request Body

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `agentId` | string | No | ID of the agent to handle the analysis. If not provided, will use the site's Customer Support agent |
| `site_id` | string | Yes | ID of the site associated with these emails |
| `limit` | number | No | Maximum number of emails to fetch (default: 10) |
| `lead_id` | string | No | Optional lead ID to associate with the analysis |
| `user_id` | string | No | Optional user ID to associate with the command |
| `team_member_id` | string | No | Optional team member ID to associate with the analysis |
| `analysis_type` | string | No | Type of analysis to perform (default: comprehensive) |

### Example Request

```json
{
  "site_id": "site_abc123",
  "limit": 15,
  "agentId": "agent_email_analyzer_123",
  "user_id": "user_xyz789",
  "analysis_type": "commercial_opportunity"
}
```

## Response

### Success Response

```json
{
  "success": true,
  "data": {
    "commandId": "cmd_xyz789",
    "status": "processing",
    "message": "Command created successfully",
    "emailCount": 15
  }
}
```

### Error Response

```json
{
  "success": false,
  "error": {
    "code": "EMAIL_CONFIG_NOT_FOUND",
    "message": "Email configuration not found for site"
  }
}
```

## Error Codes

| Code | Description |
|------|-------------|
| `INVALID_REQUEST` | Invalid request parameters |
| `UNAUTHORIZED` | Unauthorized access |
| `NOT_FOUND` | Resource not found |
| `EMAIL_CONFIG_NOT_FOUND` | Email configuration not found |
| `EMAIL_CREDENTIALS_ERROR` | Error with email credentials |
| `SMTP_CONNECTION_ERROR` | Error connecting to email server |
| `SYSTEM_ERROR` | Internal system error |

## How It Works

The API works as follows:

1. Gets the site's email configuration from `settings.channels` array where email is configured
2. Retrieves the corresponding encrypted credentials from the `secure_tokens` table
3. Connects to the email provider using SMTP/IMAP with the decrypted credentials
4. Fetches the most recent emails based on the specified limit
5. Creates a command for the AI agent to analyze the emails with the following capabilities:
   - Email content and metadata analysis
   - Sentiment analysis
   - Commercial opportunity detection
   - Lead qualification
   - Response suggestion generation

## Generated Command Structure

The system generates a command object with the following structure to control supervised email analysis tasks:

```json
{
  "task": "analyze_emails",
  "description": "Analyze incoming emails to determine if they require a commercial response, categorize them, and suggest appropriate actions.",
  "targets": [
    {
      "analysis": {
        "summary": "",
        "insights": [],
        "sentiment": "",
        "priority": "",
        "action_items": [],
        "response_suggestions": [],
        "commercial_opportunity": {
          "requires_response": false,
          "response_type": null,
          "priority_level": null,
          "suggested_actions": [],
          "potential_value": null,
          "next_steps": []
        }
      }
    }
  ],
  "tools": [
    {
      "name": "email_analysis",
      "description": "analyze email content and metadata",
      "status": "not_initialized",
      "type": "synchronous"
    },
    {
      "name": "sentiment_analysis",
      "description": "analyze sentiment and tone of email content",
      "status": "not_initialized",
      "type": "synchronous"
    },
    {
      "name": "commercial_opportunity_detection",
      "description": "detect potential commercial opportunities in email content",
      "status": "not_initialized",
      "type": "synchronous"
    },
    {
      "name": "lead_qualification",
      "description": "qualify potential leads based on email content",
      "status": "not_initialized",
      "type": "synchronous"
    },
    {
      "name": "response_suggestion",
      "description": "generate appropriate response suggestions",
      "status": "not_initialized",
      "type": "synchronous"
    }
  ]
}
```

## Notes

- The command executes asynchronously
- The API fetches emails directly from your email provider using SMTP/IMAP
- No emails are stored in the database; they are fetched on-demand for analysis
- The system will analyze the entire email thread for context
- Analysis results can be retrieved using a separate endpoint once processing is complete
- The analysis includes:
  - Commercial opportunity detection
  - Lead qualification
  - Sentiment analysis
  - Response suggestions
  - Priority assessment
  - Next steps recommendations

## Try It

You can test this API directly using our API Tester interface. The Email Analysis API tester allows you to analyze emails using any agent type and see the results.

Required fields:
- **Agent ID**: The ID of the agent
- **Site ID**: The ID of the site associated with these emails

Optional fields:
- **Limit**: Maximum number of emails to fetch and analyze
- **Analysis Type**: Type of analysis to perform
- **Lead ID**: ID of an associated lead
- **Team Member ID**: ID of the team member requesting the analysis

<UnifiedApiTester apiId="email-analysis" /> 